# 切割系统方案评估

## 当前实现分析

### ✅ 已实现的功能
1. **橡皮擦切割**：通过遮罩实现，基本工作正常
2. **性能优化**：脏区域跟踪、延迟更新、降低检查频率

### ❌ 存在的问题

#### 1. **边缘分离功能**
- **问题**：泛洪填充算法遍历整个图片，性能极差
- **原因**：
  - 每检查一次都要遍历所有像素（272-276行原代码）
  - 对每个未连接区域都进行泛洪填充，复杂度O(n²)
  - 图片大时（如1000x1000 = 100万像素）会卡死

#### 2. **性能问题**
- **卡顿原因**：
  - `check_and_remove_disconnected_regions()` 在单帧执行，阻塞主线程
  - 遍历整个图片查找分离区域
  - 多次泛洪填充操作
  - 检查频率过高（虽然已优化但仍可能触发卡顿）

#### 3. **剩余面积对比**
- **当前状态**：未实现
- **需求**：对比切割后的钥匙与目标钥匙的相似度

## 方案评估

### 当前方案：像素级遮罩 + 泛洪填充
**优点**：
- 切割效果精确
- 实现相对简单

**缺点**：
- **性能无法满足实时要求**（特别是大图片）
- 泛洪填充对整图操作太慢
- 无法保证60fps流畅运行

### 推荐方案：分层实现

#### 方案A：简化版（推荐，快速实现）
1. **保留橡皮擦功能**（当前实现，性能OK）
2. **边缘分离**：改为只在切割路径检测到闭环时触发
   - 检测切割路径是否形成闭环
   - 只移除边缘附近的分离区域（已优化）
   - 进一步降低检查频率（每200个切割点或手动触发）
3. **剩余面积对比**：
   - 使用采样方法（不是逐像素对比）
   - 对比遮罩区域覆盖率

#### 方案B：完整版（如果方案A不够）
1. **改用碰撞体切割**（更物理，性能更好）
   - 使用Polygon2D + 碰撞形状修改
   - 分离区域自动分离（物理系统处理）
2. **分层渲染**
   - 切割路径作为独立Layer
   - 分离区域自动掉落

## 已做的优化

1. ✅ 限制检查区域数量（最多10个）
2. ✅ 只检测边缘附近的分离区域
3. ✅ 采样检测（每5个像素一次）
4. ✅ 限制泛洪填充迭代次数
5. ✅ 大图片跳过检测
6. ✅ 提高检查阈值（100个切割点）

## 进一步优化建议

如果仍然卡顿，可以：

1. **完全禁用自动分离检测**
   - 只保留橡皮擦功能
   - 分离检测改为手动触发（按某个键）

2. **异步执行**
   - 使用 `call_deferred()` 或 `await` 分帧执行
   - 每帧只处理一部分像素

3. **改用更简单的判断**
   - 不检测连通性，只检测切割路径是否闭合
   - 闭合时移除闭合区域内的所有像素

